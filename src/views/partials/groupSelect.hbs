<div class="col-md-5 mb-3 mb-md-0">
  <div class="input-group">
    <div class="select-group" id="groupSelectContainer">
      <select class="form-select styled_input" id="groupSelect" aria-label="Select group name">
        <option value="" selected>Select Group Name</option>
        {{#each groups}}
          <option value="{{id}}">{{name}}</option>
        {{/each}}
        <option value="new">+ Create New Group</option>
      </select>

      <!-- Image Button -->
      <div id="groupImageBtn">
        <input type="file" id="groupImageInput" accept="image/*" hidden>
        <label for="groupImageInput">
          <img id="groupImagePreview" 
               src="data:image/svg+xml,%3Csvg width='19' height='19' viewBox='0 0 19 19' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='9.45355' cy='9.45355' r='9.45355' fill='white'/%3E%3Cg clip-path='url(%23clip0_1119_204)'%3E%3Cpath d='M2.91669 16.3287C2.64532 16.2048 2.57309 15.9917 2.57839 15.7051C2.63267 12.9293 4.77263 10.4618 7.53614 10.0142C7.88097 9.95851 8.23355 9.9347 8.58327 9.92703C9.20396 9.91371 9.82546 9.90483 10.4457 9.92743C12.8004 10.0134 14.5241 11.1182 15.6524 13.1436C16.0964 13.9408 16.2894 14.8115 16.3282 15.7196C16.3404 16.0026 16.2539 16.2072 15.9907 16.3283H2.91669V16.3287Z' fill='black'/%3E%3Cpath d='M5.33008 4.93839C5.33008 2.68811 7.18602 0.855589 9.46106 0.859626C11.7304 0.863662 13.5769 2.69336 13.5774 4.93799C13.5774 7.18828 11.721 9.0212 9.44637 9.01716C7.17827 9.01313 5.33008 7.18182 5.33008 4.93839Z' fill='black'/%3E%3C/g%3E%3Cdefs%3E%3CclipPath id='clip0_1119_204'%3E%3Crect width='13.7506' height='15.4695' fill='white' transform='translate(2.57812 0.859619)'/%3E%3C/clipPath%3E%3C/defs%3E%3C/svg%3E" 
               alt="Upload" />
        </label>
      </div>
    </div>

    <input type="text" class="form-control styled_input d-none" id="newGroupInput" placeholder="Enter new group name" />
    <button class="btn btn-outline-secondary d-none" type="button" id="addNewGroupBtn">Add</button>
  </div>
</div>

<style>
  .select-group {
    position: relative;
    flex: 1;
  }

  .select-group #groupImageBtn {
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    cursor: pointer;
    z-index: 1;
  }

  .select-group #groupImagePreview {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    object-fit: cover;
    cursor: pointer;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const groupSelectContainer = document.getElementById("groupSelectContainer");
    const groupSelect = document.getElementById("groupSelect");
    const newGroupInput = document.getElementById("newGroupInput");
    const addNewGroupBtn = document.getElementById("addNewGroupBtn");
    const groupImageInput = document.getElementById("groupImageInput");
    const groupImagePreview = document.getElementById("groupImagePreview");
    const groupImageBtn = document.getElementById("groupImageBtn");

    // Initialize global variable
    window.selectedGroupImage = null;
  
    // Disable image upload by default
    groupImageBtn.style.pointerEvents = "none";

    // Handle select field change
    groupSelect.addEventListener("change", function () {
      if (this.value !== "" && this.value !== "new") {
        this.classList.add("filled");
        groupImageBtn.style.pointerEvents = "auto";
      } else {
        this.classList.remove("filled");
        groupImageBtn.style.pointerEvents = "none";

        // Reset image preview when no group is selected
        groupImagePreview.src = "data:image/svg+xml,%3Csvg width='19' height='19' viewBox='0 0 19 19' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='9.45355' cy='9.45355' r='9.45355' fill='white'/%3E%3Cg clip-path='url(%23clip0_1119_204)'%3E%3Cpath d='M2.91669 16.3287C2.64532 16.2048 2.57309 15.9917 2.57839 15.7051C2.63267 12.9293 4.77263 10.4618 7.53614 10.0142C7.88097 9.95851 8.23355 9.9347 8.58327 9.92703C9.20396 9.91371 9.82546 9.90483 10.4457 9.92743C12.8004 10.0134 14.5241 11.1182 15.6524 13.1436C16.0964 13.9408 16.2894 14.8115 16.3282 15.7196C16.3404 16.0026 16.2539 16.2072 15.9907 16.3283H2.91669V16.3287Z' fill='black'/%3E%3Cpath d='M5.33008 4.93839C5.33008 2.68811 7.18602 0.855589 9.46106 0.859626C11.7304 0.863662 13.5769 2.69336 13.5774 4.93799C13.5774 7.18828 11.721 9.0212 9.44637 9.01716C7.17827 9.01313 5.33008 7.18182 5.33008 4.93839Z' fill='black'/%3E%3C/g%3E%3Cdefs%3E%3CclipPath id='clip0_1119_204'%3E%3Crect width='13.7506' height='15.4695' fill='white' transform='translate(2.57812 0.859619)'/%3E%3C/clipPath%3E%3C/defs%3E%3C/svg%3E";
        groupImageInput.value = ""; // Reset file input
        window.selectedGroupImage = null;
      }

      // Show input field when "Create New Group" is selected
      if (this.value === "new") {
        groupSelectContainer.classList.add("d-none");
        newGroupInput.classList.remove("d-none");
        addNewGroupBtn.classList.remove("d-none");
        newGroupInput.focus();
      } else {
        groupSelectContainer.classList.remove("d-none");
        newGroupInput.classList.add("d-none");
        addNewGroupBtn.classList.add("d-none");
        newGroupInput.value = "";
        newGroupInput.classList.remove("filled");
      }
    });

    // Handle new group input field focus and blur
    newGroupInput.addEventListener("input", function () {
      this.classList.toggle("filled", this.value.trim() !== "");
    });

    newGroupInput.addEventListener("blur", function () {
      this.classList.toggle("filled", this.value.trim() !== "");
    });

    // Prevent opening file input when no group is selected
    groupImageBtn.addEventListener("click", function (event) {
      if (!groupSelect.value || groupSelect.value === "new") {
        event.preventDefault(); // Stop default click behavior
        alert("Please select a group before uploading an image.");
      }
    });

    // Handle image selection
    groupImageInput.addEventListener("change", function (event) {
      const selectedGroup = groupSelect.value;
      const file = event.target.files[0];

      if (!selectedGroup || selectedGroup === "new") {
        alert("Please select a group before choosing an image.");
        groupImageInput.value = ""; // Reset file input
        return;
      }

      if (file) {
        window.selectedGroupImage = file;

        const reader = new FileReader();
        reader.onload = function (e) {
          groupImagePreview.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
  
    // Function to get payload
    window.getGroupPayload = function () {
      console.log(window.selectedGroupImage);
      return {
        groupId: groupSelect.value,
        groupImage: window.selectedGroupImage,
      };
    };
  });
</script>
